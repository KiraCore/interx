---
name: Build, Release, and Sign Docker Images

on:
  pull_request:
    branches:
      - master
    types:
      - closed

jobs:
  build_and_push:
    if: |
      github.event.pull_request.merged == true &&
      (startsWith(github.event.pull_request.head.ref, 'feature/') ||
       startsWith(github.event.pull_request.head.ref, 'hotfix/') ||
       startsWith(github.event.pull_request.head.ref, 'bugfix/') ||
       startsWith(github.event.pull_request.head.ref, 'release/') ||
       startsWith(github.event.pull_request.head.ref, 'major/'))
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.create_tag.outputs.new_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create and Push Tag
        id: create_tag
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          release_branches: master
          default_bump: minor
          create_annotated_tag: true

      - name: Print the new tag
        run: |
          echo "TAG: ${{ steps.create_tag.outputs.new_tag }}"
          VERSION=$(echo ${{ steps.create_tag.outputs.new_tag }} | sed 's/^v//')
          echo "VERSION: $VERSION"

      - name: Generate Changelog
        id: changelog
        run: |
          # Get the previous tag
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "No previous tag found, generating changelog from last 50 commits"
            CHANGELOG=$(git log -50 --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "Generating changelog from $PREVIOUS_TAG to HEAD"
            CHANGELOG=$(git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          # Generate changelog

          # Group commits by type
          FEATURES=$(echo "$CHANGELOG" | grep -i "^- feature:" || echo "")
          FIXES=$(echo "$CHANGELOG" | grep -i "^- fix:" || echo "")
          CICD=$(echo "$CHANGELOG" | grep -i "^- cicd:" || echo "")
          UPDATES=$(echo "$CHANGELOG" | grep -i "^- update:" || echo "")
          OTHERS=$(echo "$CHANGELOG" | grep -iv "^- \(feature:\|fix:\|cicd:\|update:\)" || echo "")

          # Build formatted changelog
          FORMATTED_CHANGELOG="## What's Changed"$'\n\n'

          if [ ! -z "$FEATURES" ]; then
            FORMATTED_CHANGELOG+="### âœ¨ Features"$'\n'"$FEATURES"$'\n\n'
          fi

          if [ ! -z "$FIXES" ]; then
            FORMATTED_CHANGELOG+="### ðŸ› Bug Fixes"$'\n'"$FIXES"$'\n\n'
          fi

          if [ ! -z "$UPDATES" ]; then
            FORMATTED_CHANGELOG+="### ðŸ”„ Updates"$'\n'"$UPDATES"$'\n\n'
          fi

          if [ ! -z "$CICD" ]; then
            FORMATTED_CHANGELOG+="### ðŸš€ CI/CD"$'\n'"$CICD"$'\n\n'
          fi

          if [ ! -z "$OTHERS" ]; then
            FORMATTED_CHANGELOG+="### ðŸ“ Other Changes"$'\n'"$OTHERS"$'\n\n'
          fi

          # Save to file for later use
          echo "$FORMATTED_CHANGELOG" > /tmp/changelog.md
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$FORMATTED_CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Install cosign
        uses: sigstore/cosign-installer@v3.5.0
        with:
          cosign-release: 'v2.2.3'

      - name: Confirm cosign installation
        run: cosign version

      - name: Log in to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Build Manager
      - name: Build and push Manager Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./manager
          file: ./manager/Dockerfile
          push: true
          tags: ghcr.io/kiracore/interx/manager:${{ steps.create_tag.outputs.new_tag }}
          build-args: |
            VERSION=${{ steps.create_tag.outputs.new_tag }}
          labels: |
            org.opencontainers.image.authors="kira.network"
            org.opencontainers.image.url="https://github.com/KiraCore/interx"
            org.opencontainers.image.documentation="https://github.com/KiraCore/interx/blob/master/README.md"
            org.opencontainers.image.source="https://github.com/KiraCore/interx.git"
            org.opencontainers.image.vendor="KIRA"
            org.opencontainers.image.licenses="CC BY-NC-SA 4.0"
            org.opencontainers.image.title="interx-manager"
            org.opencontainers.image.description="KIRA Interx Manager - P2P load balancer and HTTP server"

      - name: Retrieve Manager image digest
        id: get-manager-digest
        run: |
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ghcr.io/kiracore/interx/manager:${{ steps.create_tag.outputs.new_tag }})
          echo "Digest: $DIGEST"
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: Sign Manager Docker image
        env:
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
        run: |
          echo "${{ secrets.COSIGN_PRIVATE_KEY }}" > cosign.key
          cosign sign --key cosign.key ${{ steps.get-manager-digest.outputs.digest }} --yes
          dd if=/dev/zero of=cosign.key bs=1 count=$(stat --format=%s cosign.key)
          rm -f cosign.key

      # Build Proxy
      - name: Build and push Proxy Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./proxy
          file: ./proxy/Dockerfile
          push: true
          tags: ghcr.io/kiracore/interx/proxy:${{ steps.create_tag.outputs.new_tag }}
          build-args: |
            VERSION=${{ steps.create_tag.outputs.new_tag }}
          labels: |
            org.opencontainers.image.authors="kira.network"
            org.opencontainers.image.url="https://github.com/KiraCore/interx"
            org.opencontainers.image.documentation="https://github.com/KiraCore/interx/blob/master/README.md"
            org.opencontainers.image.source="https://github.com/KiraCore/interx.git"
            org.opencontainers.image.vendor="KIRA"
            org.opencontainers.image.licenses="CC BY-NC-SA 4.0"
            org.opencontainers.image.title="interx-proxy"
            org.opencontainers.image.description="KIRA Interx Proxy - Legacy HTTP request converter"

      - name: Retrieve Proxy image digest
        id: get-proxy-digest
        run: |
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ghcr.io/kiracore/interx/proxy:${{ steps.create_tag.outputs.new_tag }})
          echo "Digest: $DIGEST"
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: Sign Proxy Docker image
        env:
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
        run: |
          echo "${{ secrets.COSIGN_PRIVATE_KEY }}" > cosign.key
          cosign sign --key cosign.key ${{ steps.get-proxy-digest.outputs.digest }} --yes
          dd if=/dev/zero of=cosign.key bs=1 count=$(stat --format=%s cosign.key)
          rm -f cosign.key

      # Build Storage
      - name: Build and push Storage Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./worker/sai-storage-mongo
          file: ./worker/sai-storage-mongo/Dockerfile
          push: true
          tags: ghcr.io/kiracore/interx/storage:${{ steps.create_tag.outputs.new_tag }}
          build-args: |
            VERSION=${{ steps.create_tag.outputs.new_tag }}
          labels: |
            org.opencontainers.image.authors="kira.network"
            org.opencontainers.image.url="https://github.com/KiraCore/interx"
            org.opencontainers.image.documentation="https://github.com/KiraCore/interx/blob/master/README.md"
            org.opencontainers.image.source="https://github.com/KiraCore/interx.git"
            org.opencontainers.image.vendor="KIRA"
            org.opencontainers.image.licenses="CC BY-NC-SA 4.0"
            org.opencontainers.image.title="interx-storage"
            org.opencontainers.image.description="KIRA Interx Storage - MongoDB storage service"

      - name: Retrieve Storage image digest
        id: get-storage-digest
        run: |
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ghcr.io/kiracore/interx/storage:${{ steps.create_tag.outputs.new_tag }})
          echo "Digest: $DIGEST"
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: Sign Storage Docker image
        env:
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
        run: |
          echo "${{ secrets.COSIGN_PRIVATE_KEY }}" > cosign.key
          cosign sign --key cosign.key ${{ steps.get-storage-digest.outputs.digest }} --yes
          dd if=/dev/zero of=cosign.key bs=1 count=$(stat --format=%s cosign.key)
          rm -f cosign.key

      # Build Cosmos Indexer
      - name: Build and push Cosmos Indexer Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./worker/cosmos/sai-cosmos-indexer
          file: ./worker/cosmos/sai-cosmos-indexer/Dockerfile
          push: true
          tags: ghcr.io/kiracore/interx/cosmos-indexer:${{ steps.create_tag.outputs.new_tag }}
          build-args: |
            VERSION=${{ steps.create_tag.outputs.new_tag }}
          labels: |
            org.opencontainers.image.authors="kira.network"
            org.opencontainers.image.url="https://github.com/KiraCore/interx"
            org.opencontainers.image.documentation="https://github.com/KiraCore/interx/blob/master/README.md"
            org.opencontainers.image.source="https://github.com/KiraCore/interx.git"
            org.opencontainers.image.vendor="KIRA"
            org.opencontainers.image.licenses="CC BY-NC-SA 4.0"
            org.opencontainers.image.title="interx-cosmos-indexer"
            org.opencontainers.image.description="KIRA Interx Cosmos Indexer - Indexes Cosmos blockchain data"

      - name: Retrieve Cosmos Indexer image digest
        id: get-cosmos-indexer-digest
        run: |
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ghcr.io/kiracore/interx/cosmos-indexer:${{ steps.create_tag.outputs.new_tag }})
          echo "Digest: $DIGEST"
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: Sign Cosmos Indexer Docker image
        env:
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
        run: |
          echo "${{ secrets.COSIGN_PRIVATE_KEY }}" > cosign.key
          cosign sign --key cosign.key ${{ steps.get-cosmos-indexer-digest.outputs.digest }} --yes
          dd if=/dev/zero of=cosign.key bs=1 count=$(stat --format=%s cosign.key)
          rm -f cosign.key

      # Build Cosmos Interaction
      - name: Build and push Cosmos Interaction Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./worker/cosmos/sai-cosmos-interaction
          file: ./worker/cosmos/sai-cosmos-interaction/Dockerfile
          push: true
          tags: ghcr.io/kiracore/interx/cosmos-interaction:${{ steps.create_tag.outputs.new_tag }}
          build-args: |
            VERSION=${{ steps.create_tag.outputs.new_tag }}
          labels: |
            org.opencontainers.image.authors="kira.network"
            org.opencontainers.image.url="https://github.com/KiraCore/interx"
            org.opencontainers.image.documentation="https://github.com/KiraCore/interx/blob/master/README.md"
            org.opencontainers.image.source="https://github.com/KiraCore/interx.git"
            org.opencontainers.image.vendor="KIRA"
            org.opencontainers.image.licenses="CC BY-NC-SA 4.0"
            org.opencontainers.image.title="interx-cosmos-interaction"
            org.opencontainers.image.description="KIRA Interx Cosmos Interaction - Creates and publishes Cosmos transactions"

      - name: Retrieve Cosmos Interaction image digest
        id: get-cosmos-interaction-digest
        run: |
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ghcr.io/kiracore/interx/cosmos-interaction:${{ steps.create_tag.outputs.new_tag }})
          echo "Digest: $DIGEST"
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: Sign Cosmos Interaction Docker image
        env:
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
        run: |
          echo "${{ secrets.COSIGN_PRIVATE_KEY }}" > cosign.key
          cosign sign --key cosign.key ${{ steps.get-cosmos-interaction-digest.outputs.digest }} --yes
          dd if=/dev/zero of=cosign.key bs=1 count=$(stat --format=%s cosign.key)
          rm -f cosign.key

      # Build Ethereum Indexer
      - name: Build and push Ethereum Indexer Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./worker/ethereum/sai-ethereum-indexer
          file: ./worker/ethereum/sai-ethereum-indexer/Dockerfile
          push: true
          tags: ghcr.io/kiracore/interx/ethereum-indexer:${{ steps.create_tag.outputs.new_tag }}
          build-args: |
            VERSION=${{ steps.create_tag.outputs.new_tag }}
          labels: |
            org.opencontainers.image.authors="kira.network"
            org.opencontainers.image.url="https://github.com/KiraCore/interx"
            org.opencontainers.image.documentation="https://github.com/KiraCore/interx/blob/master/README.md"
            org.opencontainers.image.source="https://github.com/KiraCore/interx.git"
            org.opencontainers.image.vendor="KIRA"
            org.opencontainers.image.licenses="CC BY-NC-SA 4.0"
            org.opencontainers.image.title="interx-ethereum-indexer"
            org.opencontainers.image.description="KIRA Interx Ethereum Indexer - Indexes Ethereum blockchain data"

      - name: Retrieve Ethereum Indexer image digest
        id: get-ethereum-indexer-digest
        run: |
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ghcr.io/kiracore/interx/ethereum-indexer:${{ steps.create_tag.outputs.new_tag }})
          echo "Digest: $DIGEST"
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: Sign Ethereum Indexer Docker image
        env:
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
        run: |
          echo "${{ secrets.COSIGN_PRIVATE_KEY }}" > cosign.key
          cosign sign --key cosign.key ${{ steps.get-ethereum-indexer-digest.outputs.digest }} --yes
          dd if=/dev/zero of=cosign.key bs=1 count=$(stat --format=%s cosign.key)
          rm -f cosign.key

      # Build Ethereum Interaction
      - name: Build and push Ethereum Interaction Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./worker/ethereum/sai-ethereum-contract-interaction
          file: ./worker/ethereum/sai-ethereum-contract-interaction/Dockerfile
          push: true
          tags: ghcr.io/kiracore/interx/ethereum-interaction:${{ steps.create_tag.outputs.new_tag }}
          build-args: |
            VERSION=${{ steps.create_tag.outputs.new_tag }}
          labels: |
            org.opencontainers.image.authors="kira.network"
            org.opencontainers.image.url="https://github.com/KiraCore/interx"
            org.opencontainers.image.documentation="https://github.com/KiraCore/interx/blob/master/README.md"
            org.opencontainers.image.source="https://github.com/KiraCore/interx.git"
            org.opencontainers.image.vendor="KIRA"
            org.opencontainers.image.licenses="CC BY-NC-SA 4.0"
            org.opencontainers.image.title="interx-ethereum-interaction"
            org.opencontainers.image.description="KIRA Interx Ethereum Interaction - Creates and publishes Ethereum transactions"

      - name: Retrieve Ethereum Interaction image digest
        id: get-ethereum-interaction-digest
        run: |
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ghcr.io/kiracore/interx/ethereum-interaction:${{ steps.create_tag.outputs.new_tag }})
          echo "Digest: $DIGEST"
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: Sign Ethereum Interaction Docker image
        env:
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
        run: |
          echo "${{ secrets.COSIGN_PRIVATE_KEY }}" > cosign.key
          cosign sign --key cosign.key ${{ steps.get-ethereum-interaction-digest.outputs.digest }} --yes
          dd if=/dev/zero of=cosign.key bs=1 count=$(stat --format=%s cosign.key)
          rm -f cosign.key

      - name: Generate Image Hashes
        id: image_hashes
        run: |
          echo "## ðŸ” Image Digests & Verification" > /tmp/hashes.md
          echo "" >> /tmp/hashes.md
          echo "All Docker images are signed with cosign and can be verified using:" >> /tmp/hashes.md
          echo '```bash' >> /tmp/hashes.md
          echo 'cosign verify --key cosign.pub <image-digest>' >> /tmp/hashes.md
          echo '```' >> /tmp/hashes.md
          echo "" >> /tmp/hashes.md
          echo "### Image Digests (SHA256)" >> /tmp/hashes.md
          echo "" >> /tmp/hashes.md
          echo "| Service | Image | Digest |" >> /tmp/hashes.md
          echo "|---------|-------|--------|" >> /tmp/hashes.md
          echo "| Manager | \`ghcr.io/kiracore/interx/manager:${{ steps.create_tag.outputs.new_tag }}\` | \`${{ steps.get-manager-digest.outputs.digest }}\` |" >> /tmp/hashes.md
          echo "| Proxy | \`ghcr.io/kiracore/interx/proxy:${{ steps.create_tag.outputs.new_tag }}\` | \`${{ steps.get-proxy-digest.outputs.digest }}\` |" >> /tmp/hashes.md
          echo "| Storage | \`ghcr.io/kiracore/interx/storage:${{ steps.create_tag.outputs.new_tag }}\` | \`${{ steps.get-storage-digest.outputs.digest }}\` |" >> /tmp/hashes.md
          echo "| Cosmos Indexer | \`ghcr.io/kiracore/interx/cosmos-indexer:${{ steps.create_tag.outputs.new_tag }}\` | \`${{ steps.get-cosmos-indexer-digest.outputs.digest }}\` |" >> /tmp/hashes.md
          echo "| Cosmos Interaction | \`ghcr.io/kiracore/interx/cosmos-interaction:${{ steps.create_tag.outputs.new_tag }}\` | \`${{ steps.get-cosmos-interaction-digest.outputs.digest }}\` |" >> /tmp/hashes.md
          echo "| Ethereum Indexer | \`ghcr.io/kiracore/interx/ethereum-indexer:${{ steps.create_tag.outputs.new_tag }}\` | \`${{ steps.get-ethereum-indexer-digest.outputs.digest }}\` |" >> /tmp/hashes.md
          echo "| Ethereum Interaction | \`ghcr.io/kiracore/interx/ethereum-interaction:${{ steps.create_tag.outputs.new_tag }}\` | \`${{ steps.get-ethereum-interaction-digest.outputs.digest }}\` |" >> /tmp/hashes.md
          echo "" >> /tmp/hashes.md

          # Save for output
          cat /tmp/hashes.md
          echo "hashes<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/hashes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build Release Notes
        id: release_notes
        run: |
          cat /tmp/changelog.md > /tmp/release_notes.md
          echo "" >> /tmp/release_notes.md
          echo "## ðŸ³ Docker Images" >> /tmp/release_notes.md
          echo "" >> /tmp/release_notes.md
          echo "| Service | Image |" >> /tmp/release_notes.md
          echo "|---------|-------|" >> /tmp/release_notes.md
          echo "| Manager | \`ghcr.io/kiracore/interx/manager:${{ steps.create_tag.outputs.new_tag }}\` |" >> /tmp/release_notes.md
          echo "| Proxy | \`ghcr.io/kiracore/interx/proxy:${{ steps.create_tag.outputs.new_tag }}\` |" >> /tmp/release_notes.md
          echo "| Storage | \`ghcr.io/kiracore/interx/storage:${{ steps.create_tag.outputs.new_tag }}\` |" >> /tmp/release_notes.md
          echo "| Cosmos Indexer | \`ghcr.io/kiracore/interx/cosmos-indexer:${{ steps.create_tag.outputs.new_tag }}\` |" >> /tmp/release_notes.md
          echo "| Cosmos Interaction | \`ghcr.io/kiracore/interx/cosmos-interaction:${{ steps.create_tag.outputs.new_tag }}\` |" >> /tmp/release_notes.md
          echo "| Ethereum Indexer | \`ghcr.io/kiracore/interx/ethereum-indexer:${{ steps.create_tag.outputs.new_tag }}\` |" >> /tmp/release_notes.md
          echo "| Ethereum Interaction | \`ghcr.io/kiracore/interx/ethereum-interaction:${{ steps.create_tag.outputs.new_tag }}\` |" >> /tmp/release_notes.md
          echo "" >> /tmp/release_notes.md
          cat /tmp/hashes.md >> /tmp/release_notes.md
          echo "" >> /tmp/release_notes.md
          echo "## ðŸ“¦ Installation" >> /tmp/release_notes.md
          echo "" >> /tmp/release_notes.md
          echo "Update your \`docker-compose.yml\` to use version \`${{ steps.create_tag.outputs.new_tag }}\` or pull images directly:" >> /tmp/release_notes.md
          echo '```bash' >> /tmp/release_notes.md
          echo "docker pull ghcr.io/kiracore/interx/manager:${{ steps.create_tag.outputs.new_tag }}" >> /tmp/release_notes.md
          echo '```' >> /tmp/release_notes.md

          cat /tmp/release_notes.md
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.create_tag.outputs.new_tag }}
          release_name: Release ${{ steps.create_tag.outputs.new_tag }}
          body: ${{ steps.release_notes.outputs.notes }}
          draft: false
          prerelease: false
